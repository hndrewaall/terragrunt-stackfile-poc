name: Digger

on:
  pull_request:
    branches: [ "main" ]
    types: [ opened, synchronize ]
  issue_comment:
    types: [created]
  workflow_dispatch:

jobs:

  plan:
    name: Run digger
    runs-on: ubuntu-latest
    permissions:
      contents: write      # required to merge PRs
      actions: write       # required for plan persistence
      id-token: write      # required for workload-identity-federation
      pull-requests: write # required to post PR comments
      issues: read         # required to check if PR number is an issue or not
      statuses: write      # required to validate combined PR status
    steps:
    - name: 'Checkout'
      uses: actions/checkout@main
    - name: Generate
      uses: gruntwork-io/terragrunt-action@v2
      env:
        TG_DEVELOPMENT_GCP_PROJECT: ${{ secrets.TG_DEVELOPMENT_GCP_PROJECT }}
      with:
        tf_version: 1.11.2
        tg_version: 0.76.7
        tg_dir: live/development
        tg_command: '--experiment stacks stack generate'
    - name: Chmod
      run: sudo chown -R runner:docker live/development
    - uses: 'google-github-actions/auth@v2'
      with:
        project_id: ${{ secrets.TG_DEVELOPMENT_GCP_PROJECT }}
        credentials_json: ${{ secrets.GCP_CREDENTIALS }}
    - name: 'Set up Cloud SDK'
      uses: 'google-github-actions/setup-gcloud@v2'
      with:
        version: '>= 390.0.0'
    - name: digger run
      uses: hndrewaall/digger@stacks-support
      continue-on-error: true
      with:
        no-backend: true
        disable-locking: true
        setup-terraform: true
        setup-terragrunt: true
        terragrunt-version: 0.76.7
        reporting-strategy: multiple_comments
      env:
        TG_DEVELOPMENT_GCP_PROJECT: ${{ secrets.TG_DEVELOPMENT_GCP_PROJECT }}
        TG_STATE_BUCKET: ${{ secrets.TG_STATE_BUCKET }}
        GITHUB_CONTEXT: ${{ toJson(github) }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    # - name: Setup tmate session
    #   uses: mxschmitt/action-tmate@v3
    #   env:
    #     TG_DEVELOPMENT_GCP_PROJECT: ${{ secrets.TG_DEVELOPMENT_GCP_PROJECT }}
    #     TG_STATE_BUCKET: ${{ secrets.TG_STATE_BUCKET }}
    #     GITHUB_CONTEXT: ${{ toJson(github) }}
    #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
